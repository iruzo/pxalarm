#!/bin/sh

### BEGIN INIT INFO
# Provides:          pxalarm
# Required-Start:    $local_fs $remote_fs $network $time
# Required-Stop:     $local_fs $remote_fs $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: pxalarm daemon
# Description:       pxalarm daemon reads $XDG_CONFIG_HOME/pxalarm/config
### END INIT INFO

POSIXLY_CORRECT=1
export POSIXLY_CORRECT

while getopts dh opt 2>/dev/null
do
  case "$opt" in
    d)
      daemonize=1
      ;;
    h)
      echo "
Usage: $0 [-dh]

POSIX sh simple alarm

	-d  Daemonize and run in the background
	-h  Print this help text" >&2
      exit 0
      ;;
    ?)
      echo "Usage: $0 [-dh]" >&2
      exit 1
      ;;
  esac
done

if [ -n "$daemonize" ]; then
  nohup "$0" >/dev/null 2>&1 &
  echo "Alarm daemon started"
  exit 0
fi

while true; do
  config_path="${XDG_CONFIG_HOME}/pxalarm/config"

  if [ ! -f "$config_path" ]; then
    config_path="$HOME/.config/pxalarm/config"
  fi

  sleep $(( 60 - $(date +%S) ))

  if [ -f "$config_path" ]
  then

    while read line
    do

      if printf "$line" | grep -q "] "
      then

        year=$(date +%Y)
        month=$(date +%m)
        day=$(date +%d)
        hour=$(date +%H)
        minutes=$(date +%M)
        linedate=$(printf "$line" | sed "s/.*\[\(.*\)\].*/\1/")

        lineyear=$(printf "$linedate" | awk -F"-" "{print \$1}")
        if [ "$lineyear" != "*" ]; then
            if [ "$lineyear" != "$year" ]; then
              continue
            fi
        fi

        linemonth=$(printf "$linedate" | awk -F "-" "{print \$2}")
        if [ "$linemonth" != "*" ]; then
            if [ "$linemonth" != "$month" ]; then
              continue
            fi
        fi

        lineday=$(printf "$linedate" | awk -F "-" "{print \$3}" | cut -d" " -f1)
        if [ "$lineday" != "*" ]; then
            if [ "$lineday" != "$day" ]; then
              continue
            fi
        fi

        linehour=$(printf "$linedate" | awk -F ":" "{print \$1}" | cut -d" " -f2)
        if [ "$linehour" != "*" ]; then
            if [ "$linehour" != "$hour" ]; then
              continue
            fi
        fi

        lineminutes=$(printf "$linedate" | awk -F ":" "{print \$2}")
        if [ "$lineminutes" != "*" ]; then
            if [ "$lineminutes" != "$minutes" ]; then
              continue
            fi
        fi

        # execute
        command=$(printf "$line" | awk -F"] " "{print \$2}")
        eval "$command"

      fi

    done < "$config_path"

  fi

done
